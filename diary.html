<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
		<title>Diary</title>
		<style>
			body {
				margin: 0;
				text-align: center;
				width: 100vw;
				min-height: 100vh;
				overflow-x: hidden;
				display: flex;
				justify-content: center;
			}

			#w_today {
				max-width: 700px;
				width: calc(100vw - 40px);
				margin-top: 50px;
			}

			.card {
				margin: 20px;
				text-align: left;
				border: solid #cfac74 2px;
				border-radius: 10px;
				padding: 10px;
				background-color: #cfac7455;
			}

			.card>p {
				text-indent: 2ch;
				word-break: break-all;
			}

			.floatingBtn {
				width: 50px;
				height: 50px;
				line-height: 50px;
				text-align: center;
				border-radius: 100%;
				font-size: 50px;
				background-color: #f0f9fb;
				position: fixed;
				bottom: 50px;
				right: 50px;
				user-select: none;
				transition: .3s;
			}

			.floatingBtn:hover {
				box-shadow: 3px 1px 5px 0 rgba(26, 24, 29, .12), 0 4px 4px 0 rgba(26, 24, 29, .16);
			}

			#datetab {
				user-select: none;
				height: 50px;
				width: 100vw;
				position: fixed;
				top: 0;
				left: 0;
				padding: 5px;
				display: block;
				backdrop-filter: blur(10px);
				background-color: #d4be7344;
			}

			#datetab>button {
				width: 50px;
				height: 50px;
				font-size: 30px;
				display: inline-block;
				border: none;
				background-color: transparent;
			}

			#datetab>button:not(.smdl) {
				position: relative;
				top: -5px;
			}

			button:hover {
				cursor: pointer;
			}

			#dateweek {
				display: inline-block;
				height: 50px;
			}

			#dateweek>button {
				margin: 0;
				position: relative;
				top: -30px;
				width: 50px;
				height: 60px;
				margin-left: 5px;
				margin-right: 5px;
				border: 0;
				background-color: transparent;
				transition: .1s;
			}

			#dateweek>button:hover {
				border: solid 0.5px grey;
			}

			#dateweek>button.focus {
				background: linear-gradient(45deg, #0004, transparent);
			}

			#dateweek>button>h2 {
				margin: 0;
			}

			span.mon {
				color: grey;
			}

			#datetab>h1 {
				margin: 0;
				position: fixed;
				left: 10px;
				top: calc(25px - 0.5em);
			}

			@font-face {
				font-family: 'SMDL';
				src: url('SMDL.woff');
			}

			.smdl {
				font-family: 'SMDL';
			}
		</style>
		<script>
			function $(q) {
				return document.querySelector(q);
			}

			function $$(q) {
				return document.querySelectorAll(q);
			}
		</script>
	</head>
	<body>
		<script>
			var sec_key = "\x01";

			function sec_encode(content) {
				var secret = "";
				for (var i = 0; i < content.length; i++) {
					secret += String.fromCharCode(content[i].charCodeAt() ^ sec_key[i % sec_key.length].charCodeAt());
				}
				return secret;
			}

			var sec_decode = sec_encode;
		</script>
		<script>
			var diary;
			var date = new Date();
			var today = "";
			var dateselector_d = new Date();
			const TODAY = {
				year: date.getFullYear(),
				mon: date.getMonth() + 1,
				date: date.getDate()
			};
			date = TODAY

			function load(arg1) {
				w_today.innerHTML = "";

				diary = JSON.parse(localStorage.getItem('diary') || "{}");

				var diary_year = diary[date.year] = diary[date.year] || {};
				var diary_mon = diary_year[date.mon] = diary_year[date.mon] || {};
				today = diary_mon[date.date] || sec_encode('\n');

				today.split('\0').forEach(content => {
					create_card(sec_decode(content), true);
				})

				if (arg1 != 1) {
					var today_date = new Date(`${date.year}-${date.mon}-${date.date}`);
					switch_week(today_date);
				}
			}

			const days = ['Sun', 'Mon', 'Tue', 'Wen', 'Tur', 'Fri', 'Sat'];
			const mons = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', "Aug", 'Sep', 'Oct', 'Nov', 'Dec'];

			function switch_week(today_date) {
				var day_of_the_week = today_date.getDay();
				var hldate = new Date(`${date.year}-${date.mon}-${date.date}`);

				dateweek.innerHTML = "";
				ds_year.innerText = today_date.getFullYear();

				for (var i = 0; i < 7; i++) {
					var day = days[i];
					var btn = document.createElement('button');
					let this_date = new Date(today_date);
					this_date.setDate(today_date.getDate() - (day_of_the_week - i))

					btn.innerHTML =
						`<span class=mon>${mons[this_date.getMonth()]}.</span><h2>${this_date.getDate()}</h2><span>${day}</span>`;

					if (equ2(this_date, hldate)) {
						btn.classList = 'focus';
					} else {
						btn.onclick = function() {
							switch_date(this_date.getFullYear(), this_date.getMonth() + 1, this_date.getDate());
							dateselector_d = new Date(this_date);
						}
					}
					dateweek.appendChild(btn);
				}
			}

			function ds_month(cnt) {
				dateselector_d.setMonth(dateselector_d.getMonth() + cnt);
				open_window_sel();
			}

			function ds_week(cnt) {
				dateselector_d.setDate(dateselector_d.getDate() + 7 * cnt);
				switch_week(dateselector_d);
			}

			function ds_day(cnt) {
				dateselector_d.setDate(dateselector_d.getDate() + cnt);
				switch_date(dateselector_d.getFullYear(), dateselector_d.getMonth() + 1, dateselector_d.getDate())
			}

			function store() {
				today = [];
				for (var i = w_today.children.length - 1; i >= 0; i--) {
					x = w_today.children[i];
					if (extract_text(x).trim() != '')
						today.push(sec_encode(extract_text(x)));
				}
				today = today.join('\0');
				diary[date.year][date.mon][date.date] = today;
				localStorage.diary = JSON.stringify(diary);
			}

			function extract_text(card) {
				return card.innerText;
			}

			function equ(a, b) {
				return a.year == b.year && a.mon == b.mon && a.date == b.date;
			}

			function equ2(a, b) {
				return a.getFullYear() == b.getFullYear() && a.getMonth() == b.getMonth() && a.getDate() == b.getDate();
			}

			function create_card(text, force) {
				text = text || '';
				if (force || !$('.card') || $('.card').innerText.trim() != '') {
					w_today.innerHTML = `<div class=card ${equ(TODAY, date)?'contenteditable':''}></div>` + w_today
						.innerHTML;
					$('.card').innerText = text;
				}
			}

			function switch_date(new_year, new_mon, new_date) {
				store();
				date = {
					year: new_year,
					mon: new_mon,
					date: new_date
				}
				load();
			}

			window.onload = function() {
				load();
				if (window.innerWidth < 900) {
					ds_year.style.display = "none";
				}
				if (window.innerWidth < 650) {
					ds_week = ds_day;
					document.body.innerHTML += "<style>#dateweek>button:not(.focus){display: none;}</style>"
				}
				if (window.innerWidth < 470) {
					window_sel_h.style.zoom = 0.7;
					window_sel_t.style.zoom = 0.7;
				}
			}

			document.body.onclick = store;

			function cmd() {
				var cmd = prompt("Command:");
				switch (cmd.trim().toLowerCase()) {
					case 'export':
						document.write(`<textarea>${localStorage.diary}</textarea>`);
						break;
					case 'import':
						init_window_import();
						window_import.style.display = "block";
				}

			}
		</script>

		<div id="datetab">
			<h1 id="ds_year"></h1>
			<button class=smdl
				onclick="date=TODAY;load();switch_week(new Date(`${TODAY.year}-${TODAY.mon}-${TODAY.date}`))"
				ondblclick="cmd()">&#xecaf;</button>
			<button onclick="ds_week(-1)" class=smdl>&#xe76b;</button>
			<div id='dateweek'></div>
			<button onclick="ds_week(1)" class=smdl>&#xe76c;</button>
			<button class=smdl onclick="open_window_sel()">&#xED28;</button>
		</div>

		<div id="w_today">
		</div>
		<div onclick="create_card()" class="floatingBtn">+</div>




		<style>
			.window.container {
				position: fixed;
				top: 0;
				left: 0;
				z-index: 50000;
				width: 100vw;
				height: 100vh;
				background-color: #11111188;
			}

			.window.content {
				width: calc(100vw - 50px);
				height: calc(100vh - 50px);
				border-radius: 10px;
				background-color: #fff;
				position: relative;
				top: 15px;
				left: 15px;
				padding: 10px;
				overflow: auto;
			}

			.window.content>input {
				border: none;
				border-bottom: solid black 1px;
				margin: 5px;
				color: red;
			}

			.window.content>textarea {
				width: 100%;
				height: 400px;

				white-space: pre-wrap;
			}
		</style>
		<div id="window_import" class="window container">
			<div class="window content">
				<center>
					<h1>Import Data</h1>
				</center>
				<textarea placeholder="Data ..." id="window_import_data"></textarea>
				<div onclick="window_import.style.display='none'" class="floatingBtn" style="top: 50px;">×</div>
				<div onclick="window_import_import()" class="floatingBtn">√</div>
			</div>

			<script>
				window_import.style.display = "none";

				init_window_import = function() {
					window_import_data.value = '';
				}

				function window_import_import() {
					var data = window_import_data.value;
					if (!data) return false;

					data = JSON.parse(data);
					localStorage.diary = JSON.stringify(data);
					window.location.reload();
				}
			</script>
		</div>

		<div id="window_sel" class="window container">
			<style>
				.window.content {
					display: flex;
					justify-content: center;
					align-items: center;
				}

				table {
					background-color: white;
					height: 600px;
					display: block;
					padding: 20px;
					border-radius: 25px;
					font-size: 25px;
					font-family: times new roman;
					user-select: none;
				}

				th {
					width: 100px;
					margin: 10px;
				}

				td {
					text-align: center;
					height: 70px;
					border-radius: 1000px;
				}

				h1 {
					font-size: 60px;
				}

				sub {
					font-size: 40px;
					font-weight: heavy;
					margin: 10px;
				}

				span.shadow {}
			</style>
			<div class="window content" id="window_sel_wc" style="overflow: hidden;user-select: none;">
				<div style="text-align: center;">
					<h1 id="window_sel_h"></h1>
					<table id="window_sel_t" cellspacing="15px">
						<thead>
							<th>Sun</th>
							<th>Mon</th>
							<th>Tue</th>
							<th>Wen</th>
							<th>Thr</th>
							<th>Fri</th>
							<th>Sat</th>
						</thead>
						<tbody> </tbody>
					</table>
				</div>
				<div onclick="window_sel.style.display='none'" class="floatingBtn" style="top: 50px;">×</div>
			</div>

			<script>
				window_sel.style.display = "none";

				open_window_sel = function() {
					window_ds_open(dateselector_d.getFullYear(), dateselector_d.getMonth() + 1);
					window_sel.style.display = "block";
				}

				function window_sel_submit(seldate) {
					switch_date(dateselector_d.getFullYear(), dateselector_d.getMonth() + 1, seldate);
					window_sel.style.display = "none";
				}

				function window_ds_open(year, month) {
					function getCountDays() {
						var curDate = new Date(`${year}-${month}-1`);
						// 获取当前月份
						// 将日期设置为32，表示自动计算为下个月的第几天（这取决于当前月份有多少天）
						curDate.setDate(32);
						// 返回当前月份的天数
						return 32 - curDate.getDate();
					}

					var d = new Date(`${year}-${month}-1`);

					h = document.getElementById("window_sel_h") // 标题
					a = d.getDay() // align date
					b = getCountDays() // 一个月有几天

					h.innerHTML =
						`<span class=smdl onclick="ds_month(-1)">&#xe76b;</span> <span class=shadow>${mons[month-1]}</span><sub>/ ${year}</sub> <span class=smdl onclick="ds_month(1)">&#xe76c;</span>`;

					// 背景色
					window_sel_wc.style.background = `linear-gradient(-45deg, #ccab50 50%, #ffd664 50%)`;

					// table
					t = document.getElementById("window_sel_t").children[1];
					t.innerHTML =
						"<tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr> <tr> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> <td></td> </tr>"

					for (var i = a; i < b + a; i++) {
						console.log(t.children)
						c = t.children[Math.floor(i / 7)].children[(i) % 7];
						c.innerText = `${i+1-a}`;

						let flag = false;
						// selected day
						if (equ2(new Date(`${date.year}-${date.mon}-${date.date}`), new Date(`${year}-${month}-${c.innerText}`))) {
							c.style.background = "linear-gradient(45deg, #0004, transparent)";
							flag = true;
						}
						// a day with a diary
						if (diary[year] && diary[year][month] && diary[year][month][c.innerText])
							if (flag)
								c.style.background = "linear-gradient(45deg, #ccab5077, transparent)";
							else
								c.style.backgroundColor = "#ccab5066";

						c.onclick = function() {
							window_sel_submit(this.innerText)
						}
					}
				}
			</script>
		</div>
	</body>
</html>